steps:
  # Install dependencies
  - name: node
    entrypoint: npm
    args: ['install']
  # Run tests with coverage
  - name: node
    entrypoint: npm
    args: ['test', '--coverage']
  # Run SonarCloud analysis
  - name: 'us-docker.pkg.dev/xer-demo-devops-prd/sonar-scanner/sonar-scanner:latest'
    entrypoint: 'sonar-scanner'
    args:
      - '-Dsonar.host.url=https://sonarcloud.io'
      - '-Dsonar.projectKey=gcp-csr-demo-devops_demo-devops-gcr'
      - '-Dsonar.organization=gcp-csr-demo-devops'
      - '-Dsonar.exclusions=Dockerfile,**/*.html,**/*.json,tests/**,**/*.yaml'
      - '-Dsonar.javascript.lcov.reportPaths=coverage/lcov.info'
      - '-Dsonar.sources=.'
      - '-Dsonar.tests=tests'
    env:
      - SONAR_TOKEN=8624735de16766a8f22d48c99847cf2f1e99590b
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update
        apt-get install jq -y
        # Realizar la solicitud a la API de SonarCloud
        response=$(curl -s -u 8624735de16766a8f22d48c99847cf2f1e99590b: https://sonarcloud.io/api/qualitygates/project_status?projectKey=gcp-csr-demo-devops_demo-devops-gcr)
        # Extraer el estado del Quality Gate del JSON de respuesta
        status=$(echo $response | jq -r '.projectStatus.status')
        # Verifica el estado del Quality Gate
        if [ "$status" = "ERROR" ]; then
          echo "Quality Gate FAILED"
          exit 1
        elif [ "$status" = "OK" ]; then
          echo "Quality Gate PASSED"
          exit 0
        fi
  # Instalación de xdg-utils, lcov y generación de HTML
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update
        apt-get install xdg-utils -y
        apt-get install lcov -y
        genhtml coverage/lcov.info

artifacts:
  objects:
    location: 'gs://gcp-csr-demo-devops-gcr-logs/reportes'
    paths: ['index.html']


logsBucket: gcp-csr-demo-devops-gcr-logs
